<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>図書管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Serif JP', serif; background-color: #FDF8F0; }
        .bookshelf-bg { background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png'); background-color: #8B4513; }
        .book { transition: transform 0.2s ease-in-out, box-shadow 0.2s; position: relative; cursor: pointer; }
        .book:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .modal { display: none; } .modal.flex { display: flex; }
        .owner-btn { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .book:hover .owner-btn { opacity: 1; pointer-events: auto; }
        .book-card-content { pointer-events: none; } /* カード内のテキスト選択などを無効化 */
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 sm:p-8">
        <!-- Header and Auth Area (No Change) -->
        <header class="text-center mb-6"><h1 class="text-4xl md:text-5xl font-bold text-amber-900 drop-shadow-lg">図書管理システム</h1><p class="text-amber-700 mt-2">小さな図書室へようこそ</p></header>
        <div id="auth-area" class="mb-6 p-4 bg-white/50 backdrop-blur-sm rounded-xl shadow-md flex justify-between items-center"></div>

        <main>
            <!-- Control Panel (No Change) -->
            <div id="control-panel" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg mb-8 ring-1 ring-amber-200 hidden"><h2 class="text-2xl font-bold text-amber-800 mb-4 border-b-2 border-amber-300 pb-2">管理メニュー</h2><div class="flex flex-wrap gap-4"><button onclick="openModal('addBookModal')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">新しい図書を登録</button><button onclick="openLoanModal()" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">図書を借りる</button><button onclick="openModal('loanHistoryModal'); fetchLoanHistory();" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">貸出履歴</button></div></div>
            <!-- Bookshelf Area -->
            <div class="bookshelf-bg p-6 sm:p-10 rounded-2xl shadow-2xl"><h2 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">図書一覧</h2><div id="book-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div></div>
        </main>
    </div>

    <!-- ===== モーダルウィンドウ (更新) ===== -->
    <!-- Login/Register Modals (No Change) -->
    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl"><h3 class="text-2xl font-bold mb-6">ログイン</h3><form id="loginForm"><input type="email" id="loginEmail" placeholder="メールアドレス" class="w-full p-2 mb-4 border rounded" required><input type="password" id="loginPassword" placeholder="パスワード" class="w-full p-2 mb-4 border rounded" required><div class="flex justify-end gap-4"><button type="button" onclick="closeModal('loginModal')" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded">キャンセル</button><button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">ログイン</button></div></form></div></div>
    <div id="registerModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl"><h3 class="text-2xl font-bold mb-6">新規ユーザー登録</h3><form id="registerForm"><input type="text" id="registerName" placeholder="ユーザー名" class="w-full p-2 mb-4 border rounded" required><input type="email" id="registerEmail" placeholder="メールアドレス" class="w-full p-2 mb-4 border rounded" required><input type="password" id="registerPassword" placeholder="パスワード" class="w-full p-2 mb-4 border rounded" required><div class="flex justify-end gap-4"><button type="button" onclick="closeModal('registerModal')" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded">キャンセル</button><button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded">登録</button></div></form></div></div>
    
    <!-- Add Book Modal (Updated) -->
    <div id="addBookModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl">
            <h3 class="text-2xl font-bold mb-6">新しい図書を登録</h3>
            <form id="addBookForm">
                <input type="text" id="bookTitle" placeholder="タイトル" class="w-full p-2 mb-4 border rounded" required>
                <input type="text" id="bookAuthor" placeholder="著者" class="w-full p-2 mb-4 border rounded" required>
                <input type="text" id="bookIsbn" placeholder="ISBN (任意)" class="w-full p-2 mb-4 border rounded">
                <textarea id="bookDescription" placeholder="本の概要 (任意)" class="w-full p-2 mb-4 border rounded" rows="4"></textarea>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('addBookModal')" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded">キャンセル</button>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded">登録</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Book Modal (Updated) -->
    <div id="editBookModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl">
            <h3 class="text-2xl font-bold mb-6">図書情報を編集</h3>
            <form id="editBookForm">
                <input type="hidden" id="editBookId">
                <input type="text" id="editBookTitle" placeholder="タイトル" class="w-full p-2 mb-4 border rounded" required>
                <input type="text" id="editBookAuthor" placeholder="著者" class="w-full p-2 mb-4 border rounded" required>
                <input type="text" id="editBookIsbn" placeholder="ISBN (任意)" class="w-full p-2 mb-4 border rounded">
                <textarea id="editBookDescription" placeholder="本の概要 (任意)" class="w-full p-2 mb-4 border rounded" rows="4"></textarea>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('editBookModal')" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded">キャンセル</button>
                    <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">更新</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Book Detail Modal (New) -->
    <div id="bookDetailModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl shadow-xl max-h-[80vh] flex flex-col">
            <h3 id="detailTitle" class="text-3xl font-bold mb-2 flex-shrink-0"></h3>
            <p id="detailAuthor" class="text-lg text-gray-600 mb-6 flex-shrink-0"></p>
            <div class="overflow-y-auto flex-grow space-y-4">
                <div>
                    <h4 class="font-bold text-amber-800">概要</h4>
                    <p id="detailDescription" class="text-gray-700 whitespace-pre-wrap"></p>
                </div>
                <div>
                    <h4 class="font-bold text-amber-800">ISBN</h4>
                    <p id="detailIsbn" class="text-gray-700"></p>
                </div>
                <div>
                    <h4 class="font-bold text-amber-800">貸出状況</h4>
                    <p id="detailStatus" class="text-gray-700"></p>
                </div>
            </div>
            <div class="flex justify-end mt-6 flex-shrink-0">
                <button type="button" onclick="closeModal('bookDetailModal')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Other Modals (Loan, Loan History - No Change) -->
    <div id="loanModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl"><h3 class="text-2xl font-bold mb-6">図書を借りる</h3><form id="loanForm"><div class="mb-6"><label for="loanBookId" class="block mb-2 font-bold">借りる本:</label><select id="loanBookId" class="w-full p-2 border rounded" required></select></div><div class="flex justify-end gap-4"><button type="button" onclick="closeModal('loanModal')" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded">キャンセル</button><button type="submit" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded">借りる</button></div></form></div></div>
    <div id="loanHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-lg p-8 w-full max-w-4xl shadow-xl h-[80vh] flex flex-col"><h3 class="text-2xl font-bold mb-6 flex-shrink-0">あなたの貸出履歴</h3><div class="overflow-y-auto flex-grow"><table class="w-full text-left text-sm"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-2">書籍名</th><th class="p-2">貸出日</th><th class="p-2">返却期限</th><th class="p-2">返却日</th></tr></thead><tbody id="loanHistoryBody"></tbody></table></div><div class="flex justify-end mt-6 flex-shrink-0"><button type="button" onclick="closeModal('loanHistoryModal')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">閉じる</button></div></div></div>

    <script>
        // --- Globals & Modal Functions (No Change) ---
        let currentUser = null;
        function openModal(modalId) { document.getElementById(modalId).classList.add('flex'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('flex'); }

        // --- Auth & UI Update Functions (No Change) ---
        function updateUI() { const authArea = document.getElementById('auth-area'); const controlPanel = document.getElementById('control-panel'); if (currentUser) { authArea.innerHTML = `<p class="font-semibold">ようこそ、<span class="text-sky-700">${currentUser.name}</span> さん</p><button onclick="logout()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ログアウト</button>`; controlPanel.style.display = 'block'; } else { authArea.innerHTML = `<p>機能をすべて利用するにはログインしてください。</p><div class="flex gap-2"><button onclick="openModal('loginModal')" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">ログイン</button><button onclick="openModal('registerModal')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">新規登録</button></div>`; controlPanel.style.display = 'none'; } fetchAndDisplayBooks(); }
        async function checkLoginStatus() { const response = await fetch('/api/status'); const data = await response.json(); currentUser = data.logged_in ? data.user : null; updateUI(); }
        document.getElementById('registerForm').addEventListener('submit', async(e) => { e.preventDefault(); const name = document.getElementById('registerName').value; const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; const response = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, password }) }); const data = await response.json(); if (response.ok) { currentUser = data.user; closeModal('registerModal'); e.target.reset(); updateUI(); } else { alert(`登録エラー: ${data.error}`); } });
        document.getElementById('loginForm').addEventListener('submit', async(e) => { e.preventDefault(); const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; const response = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) }); const data = await response.json(); if (response.ok) { currentUser = data.user; closeModal('loginModal'); e.target.reset(); updateUI(); } else { alert(`ログインエラー: ${data.error}`); } });
        async function logout() { await fetch('/api/logout', { method: 'POST' }); currentUser = null; updateUI(); }

        // --- Book Display & Detail Functions (Updated) ---
        async function fetchAndDisplayBooks() {
            const response = await fetch('/api/books');
            const books = await response.json();
            const bookList = document.getElementById('book-list');
            bookList.innerHTML = '';

            books.forEach(book => {
                let statusHtml;
                if (book.is_loaned) {
                    statusHtml = (currentUser && currentUser.id === book.borrower_id)
                        ? `<button onclick="event.stopPropagation(); returnBook(${book.id})" class="mt-4 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded-md text-sm">返却する</button>`
                        : `<div class="mt-4 text-center text-red-600 font-bold text-sm py-1">貸出中</div>`;
                } else { statusHtml = `<div class="mt-4 text-center text-green-600 font-bold text-sm py-1">貸出可</div>`; }

                let ownerControls = '';
                if (currentUser && currentUser.id === book.registered_by_id) {
                    ownerControls = `
                        <div class="absolute top-1 right-1 flex gap-1 z-10">
                            <button onclick='event.stopPropagation(); openEditModal(${JSON.stringify(book)})' class="owner-btn bg-sky-600 hover:bg-sky-700 text-white text-xs p-1 rounded shadow">編集</button>
                            <button onclick="event.stopPropagation(); deleteBook(${book.id})" class="owner-btn bg-red-600 hover:bg-red-700 text-white text-xs p-1 rounded shadow">削除</button>
                        </div>`;
                }
                // The main div now has an onclick to show details
                const bookCard = `
                    <div class="book bg-white p-4 rounded-lg shadow-md flex flex-col justify-between" onclick="showBookDetails(${book.id})">
                        ${ownerControls}
                        <div class="book-card-content">
                            <h4 class="font-bold text-lg truncate" title="${book.title}">${book.title}</h4>
                            <p class="text-sm text-gray-600 truncate" title="${book.author}">${book.author}</p>
                        </div>
                        ${statusHtml}
                    </div>`;
                bookList.innerHTML += bookCard;
            });
        }
        
        // New function to show book details
        async function showBookDetails(bookId) {
            const response = await fetch(`/api/books/${bookId}/details`);
            if (!response.ok) { alert('詳細の取得に失敗しました。'); return; }
            const book = await response.json();

            document.getElementById('detailTitle').textContent = book.title;
            document.getElementById('detailAuthor').textContent = `著者: ${book.author}`;
            document.getElementById('detailDescription').textContent = book.description || '概要はありません。';
            document.getElementById('detailIsbn').textContent = book.isbn || 'N/A';
            
            if (book.is_loaned && book.due_date) {
                const dueDate = new Date(book.due_date).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('detailStatus').innerHTML = `<span class="font-bold text-red-600">貸出中</span> (返却予定日: ${dueDate})`;
            } else {
                document.getElementById('detailStatus').innerHTML = `<span class="font-bold text-green-600">貸出可</span>`;
            }

            openModal('bookDetailModal');
        }

        // --- Book CRUD Functions (Updated) ---
        document.getElementById('addBookForm').addEventListener('submit', async (e) => { e.preventDefault(); const title = document.getElementById('bookTitle').value; const author = document.getElementById('bookAuthor').value; const isbn = document.getElementById('bookIsbn').value; const description = document.getElementById('bookDescription').value; const response = await fetch('/api/books', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, author, isbn, description }) }); if (response.ok) { closeModal('addBookModal'); e.target.reset(); await fetchAndDisplayBooks(); } else { const data = await response.json(); alert(`登録エラー: ${data.error}`); } });
        
        function openEditModal(book) {
            document.getElementById('editBookId').value = book.id;
            document.getElementById('editBookTitle').value = book.title;
            document.getElementById('editBookAuthor').value = book.author;
            document.getElementById('editBookIsbn').value = book.isbn || '';
            document.getElementById('editBookDescription').value = book.description || '';
            openModal('editBookModal');
        }

        document.getElementById('editBookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const bookId = document.getElementById('editBookId').value;
            const title = document.getElementById('editBookTitle').value;
            const author = document.getElementById('editBookAuthor').value;
            const isbn = document.getElementById('editBookIsbn').value;
            const description = document.getElementById('editBookDescription').value;
            const response = await fetch(`/api/books/${bookId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, author, isbn, description })
            });
            if (response.ok) { closeModal('editBookModal'); await fetchAndDisplayBooks(); } else { const data = await response.json(); alert(`更新エラー: ${data.error}`); }
        });

        async function deleteBook(bookId) { if (!confirm('この図書を本当に削除しますか？\nこの操作は元に戻せません。')) return; const response = await fetch(`/api/books/${bookId}`, { method: 'DELETE' }); if (response.ok) { await fetchAndDisplayBooks(); } else { const data = await response.json(); alert(`削除エラー: ${data.error}`); } }
        
        // --- Loan & History Functions (Updated) ---
        async function openLoanModal() { const bookRes = await fetch('/api/books'); const books = await bookRes.json(); const availableBooks = books.filter(b => !b.is_loaned); const bookSelect = document.getElementById('loanBookId'); bookSelect.innerHTML = availableBooks.map(b => `<option value="${b.id}">${b.title}</option>`).join(''); openModal('loanModal'); }
        document.getElementById('loanForm').addEventListener('submit', async (e) => { e.preventDefault(); const book_id = document.getElementById('loanBookId').value; const response = await fetch('/api/loan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ book_id: parseInt(book_id) }) }); if (response.ok) { closeModal('loanModal'); await fetchAndDisplayBooks(); } else { const error = await response.json(); alert(`貸出エラー: ${error.error}`); } });
        async function returnBook(bookId) { if (!confirm('この本を返却しますか？')) return; const response = await fetch(`/api/return/${bookId}`, { method: 'POST' }); if (response.ok) { await fetchAndDisplayBooks(); } else { const error = await response.json(); alert(`返却エラー: ${error.error}`); } }
        async function fetchLoanHistory() { const response = await fetch('/api/loans'); if (!response.ok) { alert('貸出履歴の取得に失敗しました。ログインしているか確認してください。'); closeModal('loanHistoryModal'); return; } const loans = await response.json(); const historyBody = document.getElementById('loanHistoryBody'); historyBody.innerHTML = ''; const options = { year: 'numeric', month: 'short', day: 'numeric' }; loans.forEach(loan => { const loanDate = new Date(loan.loan_date).toLocaleDateString('ja-JP', options); const dueDate = new Date(loan.due_date).toLocaleDateString('ja-JP', options); const returnDate = loan.return_date ? new Date(loan.return_date).toLocaleDateString('ja-JP', options) : '貸出中'; historyBody.innerHTML += `<tr class="border-b"><td class="p-2">${loan.book_title}</td><td class="p-2">${loanDate}</td><td class="p-2 text-red-600">${dueDate}</td><td class="p-2">${returnDate}</td></tr>`; }); }
        
        window.onload = () => { checkLoginStatus(); };
    </script>
</body>
</html>

